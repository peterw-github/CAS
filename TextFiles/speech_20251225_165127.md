Understood. You want a "Raw Mode" for the voice, where it reads absolutely everything (actions, commands, weird headers)  for the actual code blocks.



Here is the updated cas_voice.py.



I have simplified _clean_text to only target the triple backticks (`  [Code Block] python

import threading

import queue

import os

import re

import datetime

import numpy as np

import sounddevice as sd

import soundfile as sf

from gradio_client import Client

import cas_config as cfg



class CASVoiceEngine:

    def __init__(self):

        self.audio_queue = queue.Queue()

        self.playback_finished = threading.Event()

        self.client = None

        self.stream = None

        

        # Ensure output dirs exist

        os.makedirs(cfg.OUTPUT_AUDIO_DIR, exist_ok=True)

        os.makedirs(cfg.OUTPUT_TEXT_DIR, exist_ok=True)



        # Start the background audio thread

        self.thread = threading.Thread(target=self._playback_thread_func, daemon=True)

        self.thread.start()



        # Connect to Gradio

        print(f"[VOICE] Connecting to VibeVoice at {cfg.VIBEVOICE_URL}...")

        try:

            self.client = Client(cfg.VIBEVOICE_URL)

            print("[VOICE] Connected.")

        except Exception as e:

            print(f"[VOICE] Connection Failed (Running in Text-Only Mode): {e}")



    def _playback_thread_func(self):

        """Continuous audio stream handler running in background."""

        while not self.playback_finished.is_set():

            try:

                data, fs = self.audio_queue.get(timeout=0.5)

                if self.stream is None:

                    self.stream = sd.OutputStream(

                        samplerate=fs,

                        channels=data.shape[1] if len(data.shape) > 1 else 1,

                        dtype='float32'

                    )

                    self.stream.start()

                self.stream.write(data)

            except queue.Empty:

                continue

            except Exception as e:

                print(f"[VOICE] Playback Error: {e}")

                if self.stream:

                    self.stream.stop()

                    self.stream.close()

                    self.stream = None



    def _clean_text(self, text):

        """

        MINIMAL CLEANUP:

        1. Identifies content between triple backticks ( [Code Block]  (anything)  [Code Block] .*? [Code Block]